---
title: "hzz_application"
author: "Zhenyu"
date: "2/21/2022"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```
```{r}
rm(list=ls())
library(arm)

dataset_gene <- read.csv("/Users/zhenyuzhang/Downloads/SAGE_filtered_small_dataset/dataset_74-516.csv",header=TRUE,sep="")

y_data <- c(0,0,1,1,1,1,1,1,0,0,1,1,1,1,1,0,1,1,1,1,1,1,0,1,1,1,1,
            1,1,1,1,1,1,0,0,1,0,0,1,1,0,1,0,0,0,1,1,0,1,1,0,0,0,0,
            0,1,1,1,1,0,0,1,1,0,1,0,1,1,1,1,1,1,1,1)

X_data <- apply(dataset_gene[,-1], 2, rescale)
X_data <- cbind(rep(1,dim(X_data)[1]),X_data)

set.seed(1)

# Indicators of units comprising the training set
sel_set <- sample(c(1:dim(X_data)[1]),50,replace=FALSE)

# Training data
y <- y_data[sel_set]
X <- X_data[sel_set,]

# Test data
y_new <- y_data[-sel_set]
X_new <- X_data[-sel_set,]

# Set model dimensions
n <- dim(X)[1]
p <- dim(X)[2] 

# Number of i.i.d. samples from the posterior
N_sampl <- 20000
```

```{r define the key quantities}
# Relevant parameters of the Gaussian prior
Omega <- diag(16,p,p)
omega <- sqrt(diag(Omega[cbind(1:p,1:p)],p,p))
bar_Omega <- solve(omega)%*%Omega%*%solve(omega)
xi <- matrix(0,p,1)

# Relevant parameters of the SUN posterior useful for sampling
D <- diag(2*y-1,n,n)%*%X
s <- diag(sqrt((D%*%Omega%*%t(D)+diag(1,n,n))[cbind(1:n,1:n)]),n,n)
gamma_post <- solve(s)%*%D%*%xi
Gamma_post <- solve(s)%*%(D%*%Omega%*%t(D)+diag(1,n,n))%*%solve(s)

# Other useful quantities for sampling
coef_V1 <- omega%*%bar_Omega%*%omega%*%t(D)%*%solve(D%*%Omega%*%t(D)+diag(1,n,n))%*%s
coef_V0 <- omega

Var_V0 <- bar_Omega-bar_Omega%*%omega%*%t(D)%*%solve(D%*%Omega%*%t(D)+diag(1,n,n))%*%D%*%omega%*%bar_Omega
Var_V0 <- 0.5*(Var_V0+t(Var_V0))
```

```{r the method}
start_time <- Sys.time()
set.seed(123)

V_0 <- t(mvtnorm::rmvnorm(N_sampl,mean=rep(0,p),sigma=Var_V0))
V_0_scale_plus_xi <- apply(V_0,2,function(x) xi+coef_V0%*%x)
V_1 <- TruncatedNormal::mvrandn(-gamma_post,rep(Inf,n),Gamma_post,N_sampl)
V_1_scale <- apply(V_1,2,function(x) coef_V1%*%x)

beta_SUN <- V_0_scale_plus_xi+V_1_scale
end_time <- Sys.time()

time_SUN <- difftime(end_time, start_time, units=("secs"))[[1]]
```


## R Markdown

This is an R Markdown document. Markdown is a simple formatting syntax for authoring HTML, PDF, and MS Word documents. For more details on using R Markdown see <http://rmarkdown.rstudio.com>.

When you click the **Knit** button a document will be generated that includes both content as well as the output of any embedded R code chunks within the document. You can embed an R code chunk like this:

```{r cars}
summary(cars)
```

## Including Plots

You can also embed plots, for example:

```{r pressure, echo=FALSE}
plot(pressure)
```

Note that the `echo = FALSE` parameter was added to the code chunk to prevent printing of the R code that generated the plot.
